
R version 4.2.0 (2022-04-22) -- "Vigorous Calisthenics"
Copyright (C) 2022 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> #
> # -1. packages installation
> #
> # if (!require("BiocManager", quietly = TRUE))
> #   install.packages("BiocManager")
> # BiocManager::install()
> #
> # setRepositories(ind=c(1:6))
> #
> # BiocManager::install("biomaRt")
> #
> # BiocManager::install("rhdf5")
> # BiocManager::install("devtools")
> # devtools::install_github("pachterlab/sleuth")
>
> library(biomaRt)
> library(sleuth)
>
> #
> # 0. user-defined variables
> #
> setwd("~/scratch/")
> kallisto_dir = "/home/adrian/projects/reynisfjara/results/kallisto/kallisto.100"
> metadata_file = "/home/adrian/projects/reynisfjara/metadata/reynisfjara_project_metadata\ -\ Sheet1.tsv"
> results_dir = '/home/adrian/projects/reynisfjara/results/DEGs_sleuth'
>
> #
> # 1. generate gene to transcript mapping
> #
>
> # annotation defined from sleuth walkthrough
> mart <- biomaRt::useMart(biomart = "ENSEMBL_MART_ENSEMBL",
+                          dataset = "mmusculus_gene_ensembl",
+                          host = 'https://www.ensembl.org')
> t2g <- biomaRt::getBM(attributes = c("ensembl_transcript_id", "ensembl_gene_id",
+                                      "external_gene_name"), mart = mart)
> t2g <- dplyr::rename(t2g, target_id = ensembl_transcript_id,
+                      ens_gene = ensembl_gene_id, ext_gene = external_gene_name)
> View(t2g)
>
> ### annotation defined by ALO
> # working_atributes = c("ensembl_transcript_id", "ensembl_gene_id", "external_gene_name")
> # ensembl96 = useEnsembl(biomart="genes", dataset="hsapiens_gene_ensembl", version=96)
> # t2g = getBM(attributes=working_atributes, mart=ensembl96)
> # t2g = dplyr::rename(t2g, target_id = ensembl_transcript_id, ens_gene = ensembl_gene_id, ext_gene = external_gene_name)
> # dim(t2g)
> # View(t2g)
>
> #
> # 2. read metadata
> #
> metadata = read.table(metadata_file, sep='\t', header=TRUE)
> View(metadata)
>
> #
> # 3. work on a full model
> #
>
> # define the metadata table
> s2c = metadata
> paths = file.path(kallisto_dir, s2c$sample, "abundance.h5")
> s2c$path = paths
> View(s2c)
>
> # prepare object for sleuth
> so = sleuth_prep(s2c, target_mapping=t2g, aggregation_column='ens_gene')
reading in kallisto results
dropping unused factor levels
...................................
normalizing est_counts
43243 targets passed the filter
normalizing tpm
merging in metadata
summarizing bootstraps
...................................
Warning messages:
1: In check_num_cores(num_cores) :
  It appears that you are running Sleuth from within Rstudio.
Because of concerns with forking processes from a GUI, 'num_cores' is being set to 1.
If you wish to take advantage of multiple cores, please consider running sleuth from the command line.
2: In check_target_mapping(tmp_names, target_mapping, !is.null(aggregation_column)) :
  intersection between target_id from kallisto runs and the target_mapping is empty. attempted to fix problem by removing .N from target_id, then merging back into target_mapping. please check obj$target_mapping to ensure this new mapping is correct.
>
> # build full and partial models
> so <- sleuth_fit(so, ~genotype, 'reduced')
fitting measurement error models
shrinkage estimation
4 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000130404.1, ENSMUST00000130800.7, ENSMUST00000146012.7, ENSMUST00000172571.7
computing variance of betas
> so <- sleuth_fit(so, ~genotype + time, 'full')
fitting measurement error models
shrinkage estimation
1 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000146012.7
computing variance of betas
> so <- sleuth_lrt(so, 'reduced', 'full')
>
> # tables
> sleuth_table_gene <- sleuth_results(so, 'reduced:full', 'lrt', show_all = FALSE)
> sleuth_table_gene <- dplyr::filter(sleuth_table_gene, qval <= 0.05)
> print(dim(sleuth_table_gene))
[1] 9263    6
> head(sleuth_table_gene, 20)
            target_id ext_gene num_aggregated_transcripts sum_mean_obs_counts         pval         qval
1  ENSMUSG00000022747  St3gal6                          9            39.54861 8.773524e-81 1.175038e-76
2  ENSMUSG00000045917  Tmem268                          5            27.36645 2.357709e-53 1.578840e-49
3  ENSMUSG00000003617       Cp                          8            29.93894 9.275086e-47 4.140708e-43
4  ENSMUSG00000029177    Cenpa                          6            24.89601 1.367587e-45 4.579023e-42
5  ENSMUSG00000032366     Tpm1                         15            72.95226 6.799100e-45 1.821207e-41
6  ENSMUSG00000021830  Txndc16                          9            40.10174 2.053598e-44 4.583973e-41
7  ENSMUSG00000025351     Cd63                          5            27.19202 2.509099e-44 4.800624e-41
8  ENSMUSG00000002985     Apoe                          9            42.51691 2.513964e-42 4.208690e-39
9  ENSMUSG00000022353    Mtss1                          7            26.56845 4.938379e-42 7.348857e-39
10 ENSMUSG00000020400    Tnip1                          4            22.10273 1.044650e-39 1.399099e-36
11 ENSMUSG00000025358     Cdk2                          7            44.68894 9.683634e-39 1.179026e-35
12 ENSMUSG00000035158     Mitf                          5            36.07628 1.227203e-36 1.369661e-33
13 ENSMUSG00000049092  Gpr137c                          5            18.89128 4.187338e-36 4.313925e-33
14 ENSMUSG00000038650     Rnh1                          4            22.76028 7.139331e-36 6.829790e-33
15 ENSMUSG00000039405   Prss23                          5            26.48769 7.998325e-36 7.141437e-33
16 ENSMUSG00000004040    Stat3                          6            25.42577 1.649296e-35 1.380564e-32
17 ENSMUSG00000028803   Nipal3                          8            44.50730 2.280288e-35 1.796464e-32
18 ENSMUSG00000040990  Sh3kbp1                          7            29.58567 1.606973e-34 1.195677e-31
19 ENSMUSG00000038816  Ctnnal1                          7            23.62967 2.817918e-34 1.986336e-31
20 ENSMUSG00000034842     Art3                          7            31.76936 4.596409e-34 3.077985e-31
> write.csv(sleuth_table_gene, file.path(results_dir, paste('complex', '.csv', sep='')))
>
> #
> # 4. work with smaller contrasts
> #
> mice = unique(metadata$mouse)
> induction_times = c(48, 72)
>
> for (mice_index in 1:length(mice)) {
+   for (time_index in 1:length(induction_times)) {
+
+     working_mice = mice[mice_index]
+     working_time = induction_times[time_index]
+
+     s2c = metadata[which(metadata$mouse == working_mice & (metadata$time == 0 | metadata$time == working_time)), ]
+     paths = file.path(kallisto_dir, s2c$sample, "abundance.h5")
+     s2c$path = paths
+     View(s2c)
+
+     so <- sleuth_prep(s2c, extra_bootstrap_summary = TRUE)
+     so <- sleuth_fit(so, ~time, 'full')
+     so <- sleuth_fit(so, ~1, 'reduced')
+     so <- sleuth_lrt(so, 'reduced', 'full')
+
+     sleuth_table <- sleuth_results(so, 'reduced:full', 'lrt', show_all = FALSE)
+     sleuth_table <- dplyr::filter(sleuth_table, qval <= 0.05)
+     print(dim(sleuth_table))
+     head(sleuth_table, 20)
+     write.csv(sleuth_table, file.path(results_dir, paste(paste(working_mice, working_time, sep='.'), '.csv', sep='')))
+
+   }
+ }
reading in kallisto results
dropping unused factor levels
......
normalizing est_counts
43103 targets passed the filter
normalizing tpm
merging in metadata
summarizing bootstraps
......
fitting measurement error models
shrinkage estimation
4 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000127360.1, ENSMUST00000161855.7, ENSMUST00000203643.1, ENSMUST00000208388.1
computing variance of betas
fitting measurement error models
shrinkage estimation
computing variance of betas
[1] 5990   12
reading in kallisto results
dropping unused factor levels
......
normalizing est_counts
44803 targets passed the filter
normalizing tpm
merging in metadata
summarizing bootstraps
......
fitting measurement error models
shrinkage estimation
3 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000131651.7, ENSMUST00000133799.7, ENSMUST00000192557.1
computing variance of betas
fitting measurement error models
shrinkage estimation
1 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000131651.7
computing variance of betas
[1] 7098   12
reading in kallisto results
dropping unused factor levels
......
normalizing est_counts
44351 targets passed the filter
normalizing tpm
merging in metadata
summarizing bootstraps
......
fitting measurement error models
shrinkage estimation
5 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000121871.7, ENSMUST00000122993.7, ENSMUST00000159996.7, ENSMUST00000196426.4, ENSMUST00000211050.1
computing variance of betas
fitting measurement error models
shrinkage estimation
6 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000122993.7, ENSMUST00000159996.7, ENSMUST00000196426.4, ENSMUST00000211050.1, ENSMUST00000022725.3, ENSMUST00000054125.8
computing variance of betas
[1] 1096   12
reading in kallisto results
dropping unused factor levels
.....
normalizing est_counts
43590 targets passed the filter
normalizing tpm
merging in metadata
summarizing bootstraps
.....
fitting measurement error models
shrinkage estimation
1 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000022725.3
computing variance of betas
fitting measurement error models
shrinkage estimation
computing variance of betas
[1] 2642   12
reading in kallisto results
dropping unused factor levels
......
normalizing est_counts
43607 targets passed the filter
normalizing tpm
merging in metadata
summarizing bootstraps
......
fitting measurement error models
shrinkage estimation
3 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000130705.1, ENSMUST00000152445.1, ENSMUST00000172998.7
computing variance of betas
fitting measurement error models
shrinkage estimation
3 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000130705.1, ENSMUST00000152445.1, ENSMUST00000172998.7
computing variance of betas
[1] 4143   12
reading in kallisto results
dropping unused factor levels
......
normalizing est_counts
44636 targets passed the filter
normalizing tpm
merging in metadata
summarizing bootstraps
......
fitting measurement error models
shrinkage estimation
1 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000078019.12
computing variance of betas
fitting measurement error models
shrinkage estimation
1 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000078019.12
computing variance of betas
[1] 7466   12
reading in kallisto results
dropping unused factor levels
......
normalizing est_counts
45005 targets passed the filter
normalizing tpm
merging in metadata
summarizing bootstraps
......
fitting measurement error models
shrinkage estimation
9 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000023259.14, ENSMUST00000085412.6, ENSMUST00000133959.7, ENSMUST00000182256.7, ENSMUST00000187973.1, ENSMUST00000200535.5, ENSMUST00000200999.1, ENSMUST00000201017.1, ENSMUST00000022725.3
computing variance of betas
fitting measurement error models
shrinkage estimation
3 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000022725.3, ENSMUST00000054125.8, ENSMUST00000228548.1
computing variance of betas
[1] 4344   12
reading in kallisto results
dropping unused factor levels
......
normalizing est_counts
44074 targets passed the filter
normalizing tpm
merging in metadata
summarizing bootstraps
......
fitting measurement error models
shrinkage estimation
13 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000056157.13, ENSMUST00000106313.7, ENSMUST00000120339.7, ENSMUST00000135516.7, ENSMUST00000148876.7, ENSMUST00000152887.2, ENSMUST00000153913.1, ENSMUST00000169880.2, ENSMUST00000203254.2, ENSMUST00000203265.2, ENSMUST00000220931.1, ENSMUST00000225506.1, ENSMUST00000022725.3
computing variance of betas
fitting measurement error models
shrinkage estimation
4 NA values were found during variance shrinkage estimation due to mean observation values outside of the range used for the LOESS fit.
The LOESS fit will be repeated using exact computation of the fitted surface to extrapolate the missing values.
These are the target ids with NA values: ENSMUST00000148876.7, ENSMUST00000152887.2, ENSMUST00000203265.2, ENSMUST00000225506.1
computing variance of betas
[1] 8193   12
Warning messages:
1: In check_num_cores(num_cores) :
  It appears that you are running Sleuth from within Rstudio.
Because of concerns with forking processes from a GUI, 'num_cores' is being set to 1.
If you wish to take advantage of multiple cores, please consider running sleuth from the command line.
2: In check_num_cores(num_cores) :
  It appears that you are running Sleuth from within Rstudio.
Because of concerns with forking processes from a GUI, 'num_cores' is being set to 1.
If you wish to take advantage of multiple cores, please consider running sleuth from the command line.
3: In check_num_cores(num_cores) :
  It appears that you are running Sleuth from within Rstudio.
Because of concerns with forking processes from a GUI, 'num_cores' is being set to 1.
If you wish to take advantage of multiple cores, please consider running sleuth from the command line.
4: In check_num_cores(num_cores) :
  It appears that you are running Sleuth from within Rstudio.
Because of concerns with forking processes from a GUI, 'num_cores' is being set to 1.
If you wish to take advantage of multiple cores, please consider running sleuth from the command line.
5: In check_num_cores(num_cores) :
  It appears that you are running Sleuth from within Rstudio.
Because of concerns with forking processes from a GUI, 'num_cores' is being set to 1.
If you wish to take advantage of multiple cores, please consider running sleuth from the command line.
6: In check_num_cores(num_cores) :
  It appears that you are running Sleuth from within Rstudio.
Because of concerns with forking processes from a GUI, 'num_cores' is being set to 1.
If you wish to take advantage of multiple cores, please consider running sleuth from the command line.
7: In check_num_cores(num_cores) :
  It appears that you are running Sleuth from within Rstudio.
Because of concerns with forking processes from a GUI, 'num_cores' is being set to 1.
If you wish to take advantage of multiple cores, please consider running sleuth from the command line.
8: In check_num_cores(num_cores) :
  It appears that you are running Sleuth from within Rstudio.
Because of concerns with forking processes from a GUI, 'num_cores' is being set to 1.
If you wish to take advantage of multiple cores, please consider running sleuth from the command line.
>
